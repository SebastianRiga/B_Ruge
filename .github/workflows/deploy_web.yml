name: Rust

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  deploy-web:

    runs-on: ubuntu-latest
  
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_GITHUB_TOKEN: ${{ secrets.VERCEL_GITHUB_TOKEN }}
      VERCEL_DOMAIN: ${{ secrets.VERCEL_DOMAIN }}
    steps:
    - uses: actions/checkout@v2
    - name: Install prerequisites
      run: sh ./web/scripts/init_web_assembly.sh
    - name: Build Web
      run: sh ./web/scripts/build_web.sh
    - name: Vercel Deployment
      uses: xmflsct/action-vercel-deployment@v0.5.3
      with:
        vercelToken: ${{ env.VERCEL_TOKEN }}
        vercelOrgId: ${{ env.VERCEL_ORG_ID }}
        vercelProjectId: ${{ env.VERCEL_PROJECT_ID }}
        githubToken: ${{ env.VERCEL_GITHUB_TOKEN }}
        deploySource: "web/out"
        deployProduction: true
        assignDomain: ${{ env.VERCEL_DOMAIN }}
